name: CI Pipeline

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      coverage_threshold:
        description: "Umbral mínimo de cobertura"
        required: true
        default: "80"

env:
  JAVA_VERSION: "21"

jobs:
  archetype:
    runs-on: ubuntu-22.04

    outputs:
      group: ${{ steps.maven_coords.outputs.group }}
      artifact: ${{ steps.maven_coords.outputs.artifact }}
      version: ${{ steps.maven_coords.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Mostrar contexto de GitHub
        run: |
          echo "Repo:        ${{ github.repository }}"
          echo "Evento:      ${{ github.event_name }}"
          echo "Actor:       ${{ github.actor }}"
          echo "Ref:         ${{ github.ref }}"
          echo "SHA:         ${{ github.sha }}"
          echo "Workflow:    ${{ github.workflow }}"
          echo "Run:         ${{ github.run_id }} (#${{ github.run_number }})"

      - name: Información del runner
        run: |
          echo "OS:         ${{ runner.os }}"
          echo "Arch:       ${{ runner.arch }}"
          echo "Temp:       ${{ runner.temp }}"
          echo "Tool cache: ${{ runner.tool_cache }}"

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"

      - name: Verify pom.xml exists
        run: |
          if [ -f pom.xml ]; then
            echo "pom.xml found"
          else
            echo "Error: pom.xml not found."
            exit 1
          fi
      

      - name: Extraer identificador de artefacto Maven
        id: maven_coords
        run: |
          GROUP=$(mvn -B help:evaluate -Dexpression=project.groupId -DforceStdout | grep -v '^\[INFO\]' | tail -n 1)
          ARTIFACT=$(mvn -B help:evaluate -Dexpression=project.artifactId -DforceStdout | grep -v '^\[INFO\]' | tail -n 1)
          VERSION=$(mvn -B help:evaluate -Dexpression=project.version -DforceStdout | grep -v '^\[INFO\]' | tail -n 1)

          echo "group=${GROUP}" >> "$GITHUB_OUTPUT"
          echo "artifact=${ARTIFACT}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"


      - name: Mostrar identificador de artefacto Maven
        run: |
          echo "group=software.ulpgc" >> $GITHUB_OUTPUT
          echo "group   = ${{ steps.maven_coords.outputs.group }}"
          echo "artifact= ${{ steps.maven_coords.outputs.artifact }}"
          echo "version = ${{ steps.maven_coords.outputs.version }}"

  build:
    runs-on: ubuntu-22.04
    needs: archetype

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"

      - name: Restore Maven dependencies cache
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-dependencies-${{ needs.archetype.outputs.artifact }}-${{ needs.archetype.outputs.version }}
          restore-keys: |
            maven-dependencies-${{ needs.archetype.outputs.artifact }}-
            maven-dependencies-

      - name: Build, test, package and verify (JaCoCo runs here)
        run: mvn clean compile test package verify

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: jar-${{ needs.archetype.outputs.artifact }}-${{ needs.archetype.outputs.version }}
          path: target/${{ needs.archetype.outputs.artifact }}-${{ needs.archetype.outputs.version }}.jar

      - name: Upload JaCoCo report artifact
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco

  coverage-check:
    runs-on: ubuntu-22.04
    needs: build

    steps:
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"

      - name: Download JaCoCo report artifact
        uses: actions/download-artifact@v4
        with:
          name: jacoco-report
          path: reports

      - name: Verify JaCoCo XML exists
        run: |
          if [ -f reports/jacoco.xml ]; then
            echo "reports/jacoco.xml found"
          else
            echo "Error: reports/jacoco.xml not found. Contents of reports/:"
            ls -la reports || true
            exit 1
          fi

      # (5) Usar inputs.coverage_threshold en workflow_dispatch
      - name: Check coverage threshold (>= configured)
        run: |
          set -e

          THRESHOLD="${{ inputs.coverage_threshold || vars.CI_MIN_COVERAGE }}"
          XML="reports/jacoco.xml"

          echo "Threshold configured: ${THRESHOLD}%"

          COUNTER=$(grep -oE '<counter type="LINE" missed="[0-9]+" covered="[0-9]+"\s*/>' "$XML" | tail -n 1)

          if [ -z "$COUNTER" ]; then
            echo "Error: Could not find LINE counter in $XML"
            echo "Showing available counters:"
            grep -n '<counter type="' "$XML" | head -n 50 || true
            exit 1
          fi

          MISSED=$(echo "$COUNTER"  | grep -oE 'missed="[0-9]+"'  | grep -oE '[0-9]+')
          COVERED=$(echo "$COUNTER" | grep -oE 'covered="[0-9]+"' | grep -oE '[0-9]+')
          TOTAL=$((MISSED + COVERED))

          COVERAGE=$(awk -v c="$COVERED" -v t="$TOTAL" 'BEGIN { printf "%.2f", (c/t)*100 }')

          echo "Lines missed:   $MISSED"
          echo "Lines covered:  $COVERED"
          echo "Line coverage:  ${COVERAGE}%"

          if awk -v cov="$COVERAGE" -v thr="$THRESHOLD" 'BEGIN { exit !(cov < thr) }'; then
            echo "Coverage below threshold: ${COVERAGE}% (required >= ${THRESHOLD}%)"
            exit 1
          fi

          echo "Coverage meets the threshold: ${COVERAGE}% (required >= ${THRESHOLD}%)"